
from scapy.all import sniff, IP, TCP, UDP, DNSQR
from datetime import datetime

# Creăm un fișier pentru log-uri
LOG_FILE = f"analysis_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"

def write_to_log(message):
    timestamp = datetime.now().strftime("%H:%M:%S")
    formatted_message = f"[{timestamp}] {message}"
    print(formatted_message) # Afișăm în terminal
    with open(LOG_FILE, "a") as f:
        f.write(formatted_message + "\n") # Salvăm în fișier

def process_packet(packet):
    if packet.haslayer(DNSQR):
        query = packet[DNSQR].qname.decode('utf-8')
        write_to_log(f"[DNS QUERY] Domeniu căutat: {query}")
    elif packet.haslayer(IP):
        ip_src = packet[IP].src
        ip_dst = packet[IP].dst
        if packet.haslayer(TCP):
            write_to_log(f"[TCP] Conexiune: {ip_src} -> {ip_dst}:{packet[TCP].dport}")
        elif packet.haslayer(UDP):
            write_to_log(f"[UDP] Conexiune: {ip_src} -> {ip_dst}:{packet[UDP].dport}")

print(f"[*] Monitorizarea a început. Logurile se salvează în: {LOG_FILE}")
sniff(iface="eth0", prn=process_packet, store=False)
