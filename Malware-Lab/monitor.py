from scapy.all import sniff, IP, TCP, UDP, DNSQR
from datetime import datetime

# Generate a unique log file name based on the current date and time
LOG_FILE = f"analysis_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"

def write_to_log(message):
    """Adds a timestamp and writes the message to both console and log file."""
    timestamp = datetime.now().strftime("%H:%M:%S")
    formatted_message = f"[{timestamp}] {message}"
    print(formatted_message) 
    with open(LOG_FILE, "a") as f:
        f.write(formatted_message + "\n")

def process_packet(packet):
    """Main packet analysis logic to detect suspicious network behavior."""
    
    # 1. DNS DETECTION: Check if malware is trying to resolve an attacker's domain
    if packet.haslayer(DNSQR):
        query = packet[DNSQR].qname.decode('utf-8')
        write_to_log(f"[DNS] Domain Query: {query}")
    
    # 2. IP ANALYSIS: Track source and destination of network traffic
    elif packet.haslayer(IP):
        ip_src = packet[IP].src
        ip_dst = packet[IP].dst
        
        # Analyze TCP traffic (e.g., HTTP, HTTPS, or Command & Control shells)
        if packet.haslayer(TCP):
            port = packet[TCP].dport
            # ALERT: Port 4444 is commonly used by Metasploit/Meterpreter payloads
            alert = " [!!! ALERT: POTENTIAL REVERSE SHELL]" if port == 4444 else ""
            write_to_log(f"[TCP] Connection: {ip_src} -> {ip_dst}:{port}{alert}")
            
        # Analyze UDP traffic (e.g., DNS queries or fast data exfiltration)
        elif packet.haslayer(UDP):
            write_to_log(f"[UDP] Connection: {ip_src} -> {ip_dst}:{packet[UDP].dport}")

print(f"[*] Sniffer active on eth0. Saving report to: {LOG_FILE}")
# Enable 'promiscuous' mode to capture all traffic on the network interface
sniff(iface="eth0", prn=process_packet, store=False)
