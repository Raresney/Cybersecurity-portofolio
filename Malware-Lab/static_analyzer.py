import re
import sys
import hashlib

def get_file_hashes(file_path):
    """Calculate MD5 and SHA256 hashes for file identification and VirusTotal lookups."""
    with open(file_path, "rb") as f:
        data = f.read()
        return hashlib.md5(data).hexdigest(), hashlib.sha256(data).hexdigest()

def extract_strings(file_path):
    """Extract 'Strings' (hidden text) to find URLs, IPs, or system commands inside the binary."""
    with open(file_path, "rb") as f:
        content = f.read()
    
    # Search for sequences of printable characters (minimum 4 characters long)
    all_strings = re.findall(rb"[ -~]{4,}", content)
    
    # Keywords indicating malicious behavior (Indicators of Compromise - IoCs)
    keywords = [".exe", "http", "https", "powershell", "cmd.exe", "192.168.", "temp", "download"]
    found = []

    for s in all_strings:
        try:
            decoded = s.decode('utf-8').lower()
            if any(key in decoded for key in keywords):
                found.append(decoded)
        except:
            continue
    return set(found) # Use set to remove duplicate findings

def run_analysis(file_path):
    """Coordinates the static analysis process."""
    md5, sha256 = get_file_hashes(file_path)
    print(f"\n--- STATIC ANALYSIS REPORT: {file_path} ---")
    print(f"[+] SHA256 Hash: {sha256}")
    
    suspicious = extract_strings(file_path)
    print(f"[*] Identified Indicators of Compromise (IoCs):")
    if not suspicious:
        print("  [-] No obvious indicators found.")
    else:
        for item in suspicious:
            print(f"  [!] Found: {item}")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        run_analysis(sys.argv[1])
    else:
        print("Error: Please provide a filename. Usage: python3 static_analyzer.py virus.exe")
